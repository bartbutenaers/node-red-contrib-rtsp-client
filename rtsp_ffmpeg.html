<!--
  Copyright 2022, Bart Butenaers
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script type="text/javascript">      
    RED.nodes.registerType('ffmpeg-rtsp',{
        category: 'function',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""},
            ffmpegPath: {
                value: "",
                validate: function (cmdPath) {
                    return cmdPath === '' || /^\s*$|ffmpeg/i.test(cmdPath);
                }
            },
            rtspUrl: {value: ""},
            statisticsPeriod: {value: null},
            restartPeriod: {value: null},
            autoStart: {value: "disable"},
            videoCodec: {value: "copy"},
            videoFrameRate: {value: null},
            videoWidth: {value: null},
            videoHeight: {value: null},
            videoQuality: {value: null},
            minFragDuration: {value: null},
            audioCodec: {value: "copy"},
            audioSampleRate: {value: null},
            audioBitRate: {value: null},
            transportProtocol: {value: "prefer_tcp"},
            jpegOutput: {value: "none"},
            jpegFrameRate: {value: null},
            jpegWidth: {value: null},
            jpegHeight: {value: null},
            socketTimeout: {value: null},
            maximumDelay: {value: null},
            socketBufferSize: {value: null},
            reorderQueueSize: {value: null}
        },
        credentials: {
            userName: {type: "text"},
            password: {type: "password"}
        },
        inputs:1,
        outputs:4,
        outputLabels: ["data", "status", "statistics", "jpeg"],  // statistics corresponds to the ffmpeg 'progress'
        icon: "font-awesome/fa-file-video-o",
        paletteLabel: "rtsp",
        label: function() {
            return this.name || "rtsp";
        },
        oneditprepare: function() { 
            var node = this;
            
            $("#node-input-videoCodec").on('change', function() {
                if(this.value === "none") {
                    $(".rtsp-video-input").prop('disabled', true).addClass('disabled');
                }
                else {
                    $(".rtsp-video-input").prop('disabled', false).removeClass('disabled');
                }
            });

            $("#node-input-audioCodec").on('change', function() {
                if(this.value === "none") {
                    $(".rtsp-audio-input").prop('disabled', true).addClass('disabled');
                }
                else {
                    $(".rtsp-audio-input").prop('disabled', false).removeClass('disabled');
                }
            });

            // Show tabsheets
            node.tabs = RED.tabs.create({
                id: "node-rtsp-tabs",
                onchange: function(tab) {
                    // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                    $("#node-rtsp-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            node.tabs.addTab({
                id: "node-rtsp-tab-general",
                label: "General"
            });
            node.tabs.addTab({
                id: "node-rtsp-tab-video",
                label: "MP4 Video"
            });
            node.tabs.addTab({
                id: "node-rtsp-tab-audio",
                label: "MP4 Audio"
            });
            node.tabs.addTab({
                id: "node-rtsp-tab-jpeg",
                label: "Jpeg"
            });
            node.tabs.addTab({
                id: "node-rtsp-tab-advanced",
                label: "Advanced"
            });
        },
        oneditsave: function() {
            var node = this;


        }
    });
</script>

<script type="text/x-red" data-template-name="ffmpeg-rtsp">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    </br>
        <div class="form-row">
        <!-- Tabsheets -->
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-rtsp-tabs"></ul>
    </div>
    <div id="node-rtsp-tabs-content" style="min-height: 150px">
        <!-- Content of all tabsheets -->
        <div id="node-rtsp-tab-general" style="position: relative; margin-top: 30px;">
            <div class="form-row">
                <label for="node-input-ffmpegPath"><i class="fa fa-folder"></i> FFmpeg path</label>
                <input id="node-input-ffmpegPath" type="text" style="width: 70%">
            </div>
            <div class="form-row">
                <label for="node-input-rtspUrl"><i class="fa fa-globe"></i> RTSP url</label>
                <input id="node-input-rtspUrl" type="text" style="width: 70%">
            </div>
            <div class="form-row">
                <label for="node-input-userName"><i class="fa fa-user"></i> Username</label>
                <input type="text" id="node-input-userName">
            </div>
            <div class="form-row">
                <label for="node-input-password"><i class="fa fa-lock"></i> Password</label>
                <input type="password" id="node-input-password">
            </div>
            <div class="form-row">
                <label for="node-input-transportProtocol"><i class="fa fa-truck"></i> Protocol</label>
                <select id="node-input-transportProtocol" style="width:70%;">
                    <option value="prefer_tcp">Prefer TCP</option>
                    <option value="udp">UDP</option> 
                    <option value="tcp">TCP</option>
                    <option value="udp_multicast">UDP multicast</option>
                    <option value="http">HTTP</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-statisticsPeriod"><i class="fa fa-arrows-h"></i> Stats period</label>
                <input type="number" id="node-input-statisticsPeriod">
            </div>
            <div class="form-row">
                <label for="node-input-restartPeriod"><i class="fa fa-clock-o"></i> Restart period</label>
                <input type="number" id="node-input-restartPeriod">
            </div>
            <div class="form-row">
                <label for="node-input-autoStart"><i class="fa fa-chevron-circle-right"></i> Auto start</label>
                <select id="node-input-autoStart" style="width:70%;">
                    <option value="enable">Enable</option>
                    <option value="disable">Disable</option> 
                </select>
            </div>
        </div>
        <div id="node-rtsp-tab-video" style="position: relative; margin-top: 30px;">
            <div class="form-row">
                <label for="node-input-videoCodec"><i class="fa fa-video-camera"></i> Codec</label>
                <select id="node-input-videoCodec" style="width:70%;">
                    <option value="none">No video</option> 
                    <option value="copy">Copy input codec</option> 
                    <option value="libx264">H.264</option>
                    <option value="libx265">H.265 (= HEVC)</option>
                    <option value="libx265">H.264 OMX (GPU acceleration)</option>
                    <option value="h264_mmal">H.264 MMAL (GPU acceleration RPI)</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-videoFrameRate"><i class="fa fa-tachometer"></i> Frame rate</label>
                <input type="number" id="node-input-videoFrameRate" class="rtsp-video-input">
            </div>
            <div class="form-row">
                <label for="node-input-videoWidth"><i class="fa fa-arrows"></i> Resolution</label>
                <span for="node-input-videoWidth" class="rtsp-video-input">width</span>
                <input type="number" id="node-input-videoWidth" style="width:80px" class="rtsp-video-input">
                <span for="node-input-videoHeight" class="rtsp-video-input" style="margin-left:20px;"> height</span>
                <input type="number" id="node-input-videoHeight" style="width:80px" class="rtsp-video-input">
            </div>
            <div class="form-row">
                <label for="node-input-videoQuality"><i class="fa fa-filter"></i> Quality</label>
                <input type="number" id="node-input-videoQuality" class="rtsp-video-input">
            </div>
            <div class="form-row">
                <label for="node-input-minFragDuration"><i class="fa fa-arrows-h"></i> Min frag duration</label>
                <input type="number" id="node-input-minFragDuration" class="rtsp-video-input">
            </div>            
        </div>
        <div id="node-rtsp-tab-audio" style="position: relative; margin-top: 30px;">
            <div class="form-row">
                <label for="node-input-audioCodec"><i class="fa fa-volume-up"></i> Codec</label>
                <select id="node-input-audioCodec" style="width:70%;">
                    <option value="none">No audio</option>
                    <option value="copy">Copy input codec</option>
                    <!-- FFmpeg supports two AAC-LC encoders (aac and libfdk_aac) and one HE-AAC (v1/2) encoder (libfdk_aac).     -->
                    <!-- The license of libfdk_aac is not compatible with GPL, so it will not included in pre-build ffmpeg builds.-->
                    <!-- Since we cannot require people to start compiling ffmpeg themselves, we will use the free 'aac' enocer.  -->
                    <option value="aac">AAC</option>
                    <option value="libfdk_aac">AAC FDK (non-GPL)</option>
                    <option value="libmp3lame">MP3</option>
                </select>
            </div>    
            <div class="form-row">
                <label for="node-input-audioSampleRate"><i class="fa fa-filter"></i> Sample rate</label>
                <input type="number" id="node-input-audioSampleRate" class="rtsp-audio-input">
            </div>
            <div class="form-row">
                <label for="node-input-audioBitRate"><i class="fa fa-filter"></i> Bit rate</label>
                <input type="number" id="node-input-audioBitRate" class="rtsp-audio-input">
            </div>
        </div>
        <div id="node-rtsp-tab-jpeg" style="position: relative; margin-top: 30px;">
            <div class="form-row">
                <label for="node-input-jpegOutput"><i class="fa fa-picture-o"></i> Jpeg output</label>
                <select id="node-input-jpegOutput" style="width:70%;">
                    <option value="none">None</option> 
                    <option value="all_frames">All frames</option>
                    <option value="i_frames">I-frames</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-jpegFrameRate"><i class="fa fa-tachometer"></i> Frame rate</label>
                <input type="number" id="node-input-jpegFrameRate">
            </div>
            <div class="form-row">
                <label for="node-input-jpegWidth"><i class="fa fa-arrows"></i> Resolution</label>
                <span for="node-input-jpegWidth">width</span>
                <input type="number" id="node-input-jpegWidth" style="width:80px">
                <span for="node-input-jpegHeight" style="margin-left:20px;"> height</span>
                <input type="number" id="node-input-jpegHeight" style="width:80px">
            </div>
        </div>
        <div id="node-rtsp-tab-advanced" style="position: relative; margin-top: 30px;">
            <div class="form-row">
                <label for="node-input-socketTimeout"><i class="fa fa-clock-o"></i> Socket timeout</label>
                <input type="number" id="node-input-socketTimeout">
            </div>
            <div class="form-row">
                <label for="node-input-maximumDelay"><i class="fa fa-arrows-h"></i> Maximum delay</label>
                <input type="number" id="node-input-maximumDelay">
            </div>
            <div class="form-row">
                <label for="node-input-socketBufferSize"><i class="fa fa-database"></i> Socket buffer size</label>
                <input type="number" id="node-input-socketBufferSize">
            </div>
            <div class="form-row">
                <label for="node-input-reorderQueueSize"><i class="fa fa-refresh"></i> Reorder queue size</label>
                <input type="number" id="node-input-reorderQueueSize">
            </div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="ffmpeg-rtsp">

</script>
